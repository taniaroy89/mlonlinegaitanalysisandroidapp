\chapter{Materiali e Metodi}
\ERR{Capitolo in aggiornamento}
%\myChapter{Materiali e Metodi}
\section{Fasi del lavoro svolto}
Il lavoro svolto, può essere suddiviso in tre fasi principali: 
\begin{enumerate}
	\item \textbf{Creazione ed addestramento di un modello}: scelta di un modello consono al problema e ottimizzazione dei relativi parametri,
	\item \textbf{Sviluppo applicazione}: implementazione di un programma per \textit{Smartphone} Android\tm 	del modello,
	\item \textbf{Valutazione delle prestazioni dell'applicazione in condizioni di uso reali}: il sistema ottenuto è stato valutato correlando un parametro spaziale del cammino (la distanza percorsa) a partire da quelli temporali ottenuti con la segmentazione (cadenza e velocità) e successivamente verificandone la correttezza con misurazioni dirette dei parametri spaziali tramite GPS (\textit{Global Positioning System}) sistema di posizionamento globale.
\end{enumerate}
  
\section{Creazione ed addestramento del modello}
\label{sec:creazione_addestramento_modello}
%Il sistema adattivo scelto sono le HMM. La scelta di queste ultime è giustificato sia dagli studi che il gruppo di ricerca capitanato dal prof. Sabatini, al centro di Bio-Robotica di Sant'Anna\footnote{\url{http://www-arts.sssup.it/}} sta portando avanti sulla classificazione automatica del movimento umano, sia dal fatto che lavori come "\emph{A Hidden Markov Model-based stride segmentation technique applied to equine inertial sensor trunk movement data}" di Pfau  \cite{stride_segmentation_technique_hmm} abbiano dimostrato le loro ottime potenzialità.
%Inoltre gli interessi futuri di ricerca scientifica del gruppo saranno orientati sia verso la stima dei parametri di un'attività nota sia verso la classificazione di diverse attività (se si considerano modelli di HMM gerarchici \cite{physical_activity_recognition}). Entrambi i compiti possono essere portati a termine dalle HMM.\\

%\subsection{Acquisizione dei Dati}
Sono stati scelti 6 soggetti sani (con deambulazione normale) e sono stati sottoposti a 5 sessioni di cammino e 5 sessioni di corsa.
Le prove sono state compiute su un tappeto rullante con pendenza 0°, nell'intervallo di velocità [3-7]Km/h per il cammino e [8-12]Km/h per la corsa. La prima sessione alla velocità di 3Km/h e con un incremento di 1Km/h in ciascuna sessione successiva. Ciascuna sessione è stata della durata di 2 minuti.

\begin{table}[htbp]
	\centering
	\begin{tabular}{|l|c|c|}
		\hline		
			\textbf{Attività}& cammino & corsa \\
			\hline
			\textbf{Soggetti}& 6 & 5\\
			\hline
			\textbf{Velocità}& \{3,4,5,6,7\}Km/h & \{8,9,10,11,12\}Km/h\\
			\hline
			\textbf{Durata}& \multicolumn{2}{c|}{2 minuti per attività}\\
			\hline
			\textbf{Strumenti} & \multicolumn{2}{c|}{IMU, Vicon, tappeto rullante}\\
			\hline
			\textbf{Luogo}& \multicolumn{2}{c|}{Laboratorio}\\
			\hline
			\textbf{Dati raccolti} & \multicolumn{2}{c|}{valori giroscopio monoassiale}\\
			\hline
			\textbf{Frequenza campionamento} & \multicolumn{2}{c|}{100 Hz}\\
			\hline
		\end{tabular}
	\caption{Tabella riassuntiva della raccolti dati}
	\label{tab:TabellaRiassuntivaRaccoltaDati}
\end{table}

Le sessioni sono state tutte eseguite posizionando saldamente una IMU (vedi appendice \ref{sec:sensori}) sul collo del piede dei soggetti mediante un cinturino in velcro. Il tipo di sensore usato è un giroscopio monoassiale (Murata ENC-03J) con asse di sensibilità orientato sul piano mediale-laterale (sagittale) (vedi figura \ref{fig:HumanBodySPL}).\\
I segnali sono stati campionati dal sensore ad una frequenza di 100 Hz e filtrati mediante un filtro passa-basso\footnote{Un filtro elettronico nella Teoria dei Segnali è un circuito elettronico che riceve dei segnali in ingresso e li trasforma secondo un criterio. Un filtro passa-banda (banda alta o banda bassa) lascia passare segnali a frequenza in un intervallo scelto mentre blocca il passaggio (o le attenua) il passaggio di segnali fuori dall'intervallo. Un filtro passa-basso quindi lascia passare le frequenze basse, e smorza quelle a frequenze alte.} a 15Hz mediante un filtro ricorsivo \textit{forward-backward}(Fw-Bkw)\footnote{Un filtro ricorsivo riusa i propri valori in uscita come ingresso. In particolare un filtro Fw-Bkw è un filtro ricorsivo che viene utilizzato per avere un segnale simmetrico.} di \textit{Buttersworth}\footnote{Filtro detto "`massimamente piatto"', perché non solo rifiuta i segnali a frequenze non desiderate, ma ha la stessa sensibilità per tutte le frequenze desiderate.}. 
Dai dati raccolti, quelli considerati per lo studio sono quelli compresi nell'intervallo dai 50 ai 110 secondi. \\

\begin{figure}
	\centering
		\includegraphics[width=1\textwidth]{imgs/patternGyro.jpg}
	\caption{Grafico del segnale di un giroscopio posizionato sul piede.}
	\label{fig:gyroPattern}
\end{figure}

Il grafico del segnale del giroscopio posizionato sul piede ha una struttura definita e ripetitiva (vedi grafico \ref{fig:gyroPattern}). Nel grafico, l'ascissa rappresenta i campioni e l'ordinata la velocità angolare in gradi al secondo (°/s). La forma del grafico può essere descritta a grandi linee come un picco negativo seguito da un tratto quasi orizzontale ed un secondo picco negativo ed uno positivo. Tale sequenza rappresenta un passo completo e si ripete quasi identica a se stessa durante la camminata.



In lavori precedenti \cite{walking_features_from_inertials}, gli eventi ($t_{HS}$, $t_{FF}$, $t_{HO}$, $t_{FO}$ ) vengono determinati mediante soglie, sulla velocità angolare $\omega_k$, come mostra la Tabella \ref{tab:regole_threshold_eventi}, dove $\widetilde{\omega_k}$ è il valore non filtrato del giroscopio.

\begin{table}%
\centering
\begin{tabular}{|c|l p{5cm}|}
\hline
\textbf{Evento} & \multicolumn{2}{c|} {\textbf{regola}}\\
%\hline
\hline
$t_{HS}$ & $ \omega_k \leq 0 $ e $ min_1 \leq  \omega_k$ & $\displaystyle\max_{\forall k}|\widetilde{\omega_k} - \omega_k|$\\
%\hline
$t_{FF}$ & $|\omega_k|\geq  50$°/s&\\
%\hline
$t_{HO}$ & $|\omega_k|\geq  50$°/s &\\
%\hline
$t_{FO}$ & $\omega_k = 0$ & se $\omega$ da negativo è diventato positivo e cresce fino al suo massimo.\\
\hline	 
\end{tabular}
\caption{Regole mediante le quali vengono ricavati gli eventi che delimitano le 4 fasi del cammino.}
\label{tab:regole_threshold_eventi}
\end{table}


Nel lavoro presentato i dati acquisiti con la IMU sono stati confrontati con dati acquisiti mediante stereofotogrammetria, seguendo una procedura usata per uno studio con obbiettivo la costruzione di un sistema Stimolazione Elettrica Funzionale (FES) per pazienti con problemi motori dovuti a lesioni celebrali \cite{reliable_gait_phase_analysis}.

Il sistema ottico commerciale di analisi del movimento usato è Vicon\tm 370 (Oxford Metrics Ltd., UK) \ref{sec:stereofotogrammetria}.
Con Vicon\tm sono state tracciate e misurate le traiettorie di marcatori retro riflettenti posizionati sul corpo dei soggetti. 
Sono state posizionate 4 telecamere con una frequenza di campionamento di 50Hz, intorno al tappeto rullante, per tracciare la posizione di 5 marcatori con un'accuratezza di $\pm 1mm$ ed il software Workstation\tm.
Le traiettorie dei marcatori sono state usate per estrarre un segnale di riferimento per le fasi della deambulazione, che successivamente sono state usate per valutare l'accuratezza del segnale in uscita dal sistema di riconoscimento degli eventi.


\begin{table}%
\centering
\begin{tabular}{|p{4cm}|p{6cm}|}
\hline
\textbf{Nome} & \textbf{Posizione} \\
\hline
HM (\textit{Heel Marker}) & lato posteriore del tallone;\\
\hline	 
AM (\textit{Ancle Marker}) & lato esterno della caviglia;\\
\hline
TM (\textit{Toe Marker}) &  giuntura metatarso-falange dell'alluce;\\
\hline
ThM (\textit{Thigh Marker}) & lato esterno della coscia, ad un terzo dell'altezza della coscia a partire dal ginocchio;\\
\hline
LSM (\textit{Lombaro Sacral Marker}) & tra la zona lombare e sacrale.\\
\hline
\end{tabular}
\caption{Posizionamento dei marcatori sul corpo.}
\label{tab:marker_positioning}
\end{table}


Le regole usate per generare il segnale di riferimento Vicon\tm si basano sul tracciamento di soli 2 marcatori: HM e TM.

\begin{table}%
\centering
\begin{tabular}{|p{2cm}|p{4cm}|p{4cm}|}
\hline
&\textbf{min} & \textbf{max} \\
\hline
HM & inizio fase Sw & Evento HS\\
\hline	 
TM & primo picco: fine Fase HO, secondo picco fine fase Sw&  fase \textit{Stance}\\
\hline
\end{tabular}
\caption{Valori minimi e massimi assunti dai marcatori HM e TM.}
\label{tab:min_max_HM_TM}
\end{table}


\begin{table}%
\centering
\begin{tabular}{|p{3.3cm}|p{3.3cm}|p{3.3cm}|}
\hline
\textbf{Evento} & \textbf{Condizione} & \textbf{Posizione in Figura \ref{fig:vicon_traced_TM_HM}} \\
\hline
HO & $y(HM) > 80mm$ & A\\
TO & $\max y(HM)$ & B\\
HS & $\min y(HM)$ & C\\
FF & $y'(TM) = 0$ & D\\
\hline
\end{tabular}
\caption{Regole usate per generare il segnale di riferimento Vicon\tm.}
\label{tab:vicon_rules}
\end{table}

\begin{figure}
	\centering
		\includegraphics[width=1\textwidth]{imgs/ViconMeasurementsPappas.jpg}
	\caption{Tracciamento mediante Vicon\tm dei marcatori HM e TM. Immagine riadattata da \cite{reliable_gait_phase_detection_gyr}}
	\label{fig:vicon_traced_TM_HM}
\end{figure}


Si assume che i segnali del giroscopio siano modellati mediante una HMM:
 \begin{equation}
	Deamb\_HMM = <N, M, \mathbf{A}, \mathbf{B}, \pi>
\label{eq:deamb_hmm}
\end{equation}
dove:
 \begin{enumerate}
	\item $N = 4$ è la cardinalità dell'insieme degli stati $S = \{HS, FF, HO, FO\}$. Gli stati corrispondono agli intervalli fra un evento ed il successivo come mostra la tabella \ref{tab:4_fasi_deambulazione},
	\item $M = |V|$ è la cardinalità dell'insieme finito dei valori di osservazione $\omega (^\circ/s)$ del giroscopio,
	\item $\mathbf{A}$ è la matrice di transizione (vedi appendice \ref{cap:hmm}),
	\item $\mathbf{B}$ è la matrice di probabilità di emissione delle osservazioni $\omega$ per ciascuno stato. Ad ogni stato è stata associata una funzione di densità di probabilità gaussiana univariata.
	\item $\pi$ è il vettore di probabilità a priori.
\end{enumerate}

\begin{table}%
\centering
\begin{tabular}{|c|cc|}
\hline
\textbf{Stato} & \textbf{inizio} & \textbf{fine} \\
%\hline
\hline
$S_1$ & $t_{HS}$ & $t_{FF}$\\
%\hline
$S_2$ & $t_{FF}$ & $t_{HO}$\\
%\hline
$S_3$ & $t_{HO}$ & $t_{FO}$\\
%\hline
$S_4$ & $t_{FO}$ & $t_{HS}$\\
\hline	 
\end{tabular}
\caption{Le quattro fasi della deambulazione e gli eventi (tempo iniziale e finale) che li definiscono.}
\label{tab:4_fasi_deambulazione}
\end{table}
Per semplicità si può indicare uno stato $S_i$ con l'evento da cui ha inizio, ad esempio con lo stato $HS$ indico lo stato $S_1$.


A questo punto sono state addestrate le HMM. 
Come prima operazione, è stato etichettato un sottoinsieme dei dati: ad una sequenza $\Omega$ di dati è stato  associato un vettore $Y$ di etichette. Questo è stato fatto con l'uso del sistema di telecamere Vicon\tm (vedi sezione \ref{sec:stereofotogrammetria}).

%Grazie a un analisi di tipo stereofotogrammetrico (sistema di telecamere Vicon (vedi \TODO{Pappas}) sono stati etichettati i dati acquisiti. 

% addestramento HMM 

Dato che nella deambulazione normale le uniche transizioni tra stati sono quelle tra stati contigui o quelle che riportano nello stesso stato, il modello migliore il tipo di HMM scelto è il modello left-right (vedi appendice \ref{sec:tipi_hmm}). Ciò significa che la matrice di transizione gode della proprietà di avere transizioni solo verso stati successivi (da qui il nome "da sinistra - a destra"):
\begin{equation}
	a_{ij} > 0 \quad \text{sse} \quad j=i \quad \text{oppure}\quad j=i+1 \quad \text{oppure} \quad(i = N \quad\text{e}\quad j = 1)
\label{eq:}
\end{equation}
Una volta deciso il tipo di HMM adottare, si devono stimare i parametri del modello.
La stima (dei parametri del modello) della massima verosimiglianza (\textit{Maximum Likelihood Estimation} - MLE) $\ell(\Omega, Deamb\_HMM )$ non è un problema convesso dato. Il problema dei massimi locali viene aggirato con un'attenta inizializzazione dei parametri. 

Assumendo che possa avvenire solo una transizione tra stati contigui, in ciascun ciclo di deambulazione possono essere fatte delle stime approssimative dei parametri della HMM:
\begin{equation}
\begin{split}
\pi_i & = N_i/N_{tot} \\
a_{ij}& = C/N_i \quad \text{dove}\quad j = (i+1)\%Q \\
\mu_i &= \dfrac{1}{N_i} \displaystyle \sum_{t=1}^T{\Omega(t)}\\
\sigma_i &= \sqrt{\dfrac{1}{N_i -1}\displaystyle \sum_{t=1}^T({\Omega(t)-\mu_i})^2}
\end{split}	 
\label{eq:emissionMtx}
\end{equation}
dove $N_i$ è il numero di valori etichettati con l'etichetta $i$-esima nel vettore di etichette $Y$ e $C$ è il numero di cicli di deambulazione nel training set.\\ 

I parametri di emissione ( $\mu$ e $\sigma$) per ciascuno stato $i$ sono stimati calcolando delle medie e deviazioni standard empiriche dagli output osservabili dei quali si conosce lo stato che li ha emessi.\\

La validazione è stata fatta con l'approccio leave-one-subject-out cross-validation (LOOCV). 
Il metodo consiste nell'addestrare un modello su P-1 ($P=6$) soggetti e testarne la validità su 1 soggetto. Ripetendo P volte la procedura per ciascuno dei soggetti alla fine i risultati vengono combinati.

Tutta la prima fase della creazione addestramento e validation incrociata del modello è stata fatta in differita, mediante un Mathworks\tm MATLAB\tm ed l'\textit{HMM toolbox} \cite{HMM_toolbox}. 
Nella fase di verifica, viene usato l'algoritmo di decodifica di Viterbi \ref{alg:viterbi} sui dati del giroscopio, per trovare la sequenza di stati che con maggior verosimiglianza ha prodotto le osservazioni (sequenze di valori del giroscopio).
Il modello sinistra-destra dell'HMM (vedi appendice \ref{sec:HMM}) può portare a considerare cicli di deambulazione aggiuntivi detti inserzioni (\textit{insertions}), o meno di quelli effettivi delezioni (\textit{deletions}). Il problema delle inserzioni viene risolto mediante l'applicazione di un'euristica: per i presupposti del tipo di deambulazione considerata (velocità e pendenza del terreno), tutti i cicli di deambulazione di durata inferiore a \TODO{tot} secondi sono inserzioni.\\

I parametri del modello stimati da una delle esecuzioni della validazione incrociata è il seguente:
Dati:  HMM



\begin{table}%
\centering
\begin{tabular}{|c|c c c c|}
\hline
\textbf{A} &\textsc{HS} & \textsc{FF} & \textsc{HO} & \textsc{TO}\\
%\hline
\hline
\textsc{HS} & $0.985$ & $0.015$ & $0.0$ & $0.0$\\
%\hline
\textsc{FF} & $0.0$ & $0.998$ & $0.002$ & $0.0$\\
%\hline
\textsc{HO} & $0.0$ & $0.0$ & $0.991$ & $0.009$\\
%\hline
\textsc{FO} & $0.007$ & $0.0$ & $0.0$ & $0.993$\\
\hline	 
\end{tabular}
\caption{Matrice di Transizione}
\label{tab:matrice_transizione}
\end{table}


\begin{table}%
\centering
\begin{tabular}{|c|c c|}
\hline
\textbf{B} &\textsc{$\mu$[°/s]} & \textsc{$\sigma ^2$[°/s]}\\
%\hline
\hline
\textsc{HS} & $-52.2$ & $12711.8$\\
%\hline
\textsc{FF} & $-11.8$ & $898.7$\\
%\hline
\textsc{HO} & $-180.1$ & $35806.8$\\
%\hline
\textsc{FO} & $233$ & $14980.3$\\
\hline	 
\end{tabular}
\caption{Matrice di Emissione}
\label{tab:matrice_emissione}
\end{table}


\begin{table}%
\centering
\begin{tabular}{|p{.7cm}|p{2.8cm}|}
\hline
 &\textsc{$\pi$} \\
%\hline
\hline
\textsc{HS} & $0.180$ \\  
%\hline
\textsc{FF} & $0.278$ \\
%\hline
\textsc{HO} & $0.279$ \\
%\hline
\textsc{FO} & $0.264$\\
\hline	 
\end{tabular}
\caption{Distribuzione di probabilità iniziale}
\label{tab:prior}
\end{table}
Le seguenti sono un esempio di osservazioni: 12400 dati Giroscopio
\begin{table}%
\centering
\begin{tabular}{|c|c|}
\hline
 time&\textsc{$O$} \\
%\hline
\hline
\textsc{1} & $0.37694$\\  
\textsc{2} & $0.37694$\\
\textsc{3} & $0.37694$\\
\textsc{4} & $0.37694$\\
\textsc{5} & $-1.9058$\\
\vdots & \vdots\\
\textsc{24800} & $-16.831$\\
\hline	 
\end{tabular}
\caption{Osservazioni Giroscopio: velocità angolari}
\label{tab:osservazioni}
\end{table}

%I risultati ottenuti hanno un errore che va dal 3.5\% al 4.7\% che sono errori trascurabili se si considera il numero di fattori in gioco.

%\section[Direzione scelta]{Strategia scelta per la risoluzione del problema dell'analisi del cammino}
%\begin{figure}
%	\centering
%		\includegraphics[width=1\textwidth]{imgs/SchemaClassificazioneGenerica.jpg}
%	\caption{Schema concettuale di un sistema di classificazione generico}
%	\label{fig:SchemaClassificazioneGenerica}
%\end{figure}
%\subsection{Selezione dei Sensori}
%\subsection{Acquisizione dei dati}
%\subsection{Specifica delle Feature: valutazione, selezione, estrazione}
%I dati acquisiti devono essere elaborati prima di essere classificati. La classificazione viene fatta su delle rappresentazioni dei dati come variabili di feature (attributi). La scelta dei feature viene fatta caso per caso. 
%La valutazione di feature, avviene spesso in finestre di dimensione fissa che vengono chiamate dataframe. \\
%
%Le feature devono essere selezionate per un triplice motivo: migliorare la performance della classificazione, in modo più rapido (perché diminuisce il numero di variabili della computazione)e fornire una comprensione migliore del processo sottostante alla generazione dei dati in considerazione. 
%Guyon et al.\cite{intro_variable_feature_selection} nel loro articolo danno un algoritmo euristico per una buona selezione di feature:
%
%\begin{enumerate}
%	\item \textbf{Conosci il dominio del problema?} Se si, costruisci un insieme migliore di feature ad-hoc.
%	\item \textbf{Le tue feature sono proporzionate?} Se no normalizzale.
%	\item \textbf{Sospetti un'interdipendenza di feature?} Se si, espandi il tuo insieme di feature, costruende feature congiuntive o prodotti di feature, al massimo delle potenzialità del tuo computer.
%	\item \textbf{Devi potare le variabili di input (per motivi di velocità, o migliore comprensione dei dati)?} Se no, costruisci delle feature disgiuntive o somme pesate di feature (ad esempio per raggruppamenti (clustering) o fattorizzazioni di matrici)
%\item \textbf{Devi valutare delle feature individualmente (ad esempio per capire il loro impatto sul sistema o perché sono così tanti che devi prima fare un filtraggio?)} Se si, usa un metodo di ranking di variabili, altrimenti fallo lo stesso per avere dei risultai di partenza. 
%\item \textbf{Sospetti che i tuoi dati siano spuri? (Hanno alcuni input senza senso o output con del rumore o con etichette di classi errate)}.Se si, individua gli esempi sbagliati con il ranking del passo precedente come gli esempi con il punteggio più alto ed esaminali o eliminali. 
%\item \textbf{Sai cosa provare prima?} Se no, usa un predittore lineare. Usa un metodo di selezione forward, con un un criterio di arresto a sonda (probe). Per confrontare i risultati, in base al ranking, costruisci una sequenza di predictor, che si differenzino solo per la grandezza del sottoinsieme di feature che usano.
%Puoi ridurre le dimensioni dei sottoinsiemi ed avere una performance pari o addirittura migliore? Se si, prova un predictor non-lineare con quel particolare sottoinsieme. 
%\end{enumerate}
%
%\subsection{Valutazione}
%\subsection{Selezione}
%\subsection{Estrazione}
%\subsection{Fase di addestramento}
%\subsection{Selezione ed Estrazione delle Feature}
%\subsection{Classificazione}
%
%\subsection{Fase di valutazione}
%\subsection{Selezione ed Estrazione delle Feature}
%\subsection{Classificazione}
%\subsection{Valutazione di performance}
%
%
%\section{Hardware}
%IMU \footnote{Inertial Measurement Unit}
%\begin{itemize}
%	\item Scheda -- dimensioni--processore, RAM, memoria FLASH
%	\item Bluetooth
%	\item Gyroscope
%\end{itemize}
%\section{software}
%\begin{itemize}
%	\item sistema operativo IMU
%	\item protocollo di comunicazione Mailbox
%	\item Ambiente Android 
%	\item Algoritmi di Machine Learning 
%\end{itemize}


