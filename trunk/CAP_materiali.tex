\chapter{Materiali e Metodi}
%\myChapter{Materiali e Metodi}
\section{Introduzione}
Il lavoro complessivo, può essere suddiviso in tre fasi principali: 
\begin{enumerate}
	\item \textbf{creazione ed addestramento di un modello}: scelta di un modello consono al problema e ottimizzazione dei relativi parametri,
	\item \textbf{implementazione}: stesura applicativo per Android che implementi il modello,
	\item \textbf{applicazione e test}: abbiamo correlato un parametro spaziale del cammino (la distanza percorsa) a partire da quelli temporali ottenuti con la segmentazione (cadenza e velocità) e successivamente verificandone la correttezza con misurazioni dirette dei parametri spaziali (misurazione della distanza fatta con il GPS).
\end{enumerate}
  
\section{Creazione ed addestramento del modello}
\label{sec:creazione_addestramento_modello}
Il sistema adattivo scelto sono le HMM. La scelta di queste ultime è giustificato sia dagli studi che il gruppo di ricerca capitanato dal prof. Sabatini, al centro di Bio-Robotica di Sant'Anna\footnote{\url{http://www-arts.sssup.it/}} sta portando avanti sulla classificazione automatica del movimento umano, sia dal fatto che lavori come "\emph{A Hidden Markov Model-based stride segmentation technique applied to equine inertial sensor trunk movement data}" di Pfau  \cite{stride_segmentation_technique_hmm} abbiano dimostrato le loro ottime potenzialità.
Inoltre gli interessi futuri di ricerca scientifica del gruppo saranno orientati sia verso la stima dei parametri di un'attività nota sia verso la classificazione di diverse attività (se si considerano modelli di HMM gerarchici \cite{physical_activity_recognition}). Entrambi i compiti possono essere portati a termine dalle HMM.\\

\subsection{Dati}
Sono stati scelti 6 soggetti sani (con deambulazione normale)\footnote{non patologico} e sono stati sottoposti a 5 sessioni di cammino e 5 sessioni di corsa.
Le prove sono state compiute su threadmill su un intervallo di velocità [3-7]Km/h per il cammino e [8-12]Km/h per la corsa. Ciascuna sessione è stata della durata di 2 minuti. La prima sessione alla velocità di 3Km/h e con un incremento di 1Km/h in ciascuna sessione successiva.

\begin{table}[htbp]
	\centering
		\begin{tabular}{|l|l|}
		\hline
			\textbf{Attività 1}& cammino \{3,4,5,6,7\}Km/h\\
			\textbf{Soggetti}& 6\\
			\hline
			\textbf{Attività 2}& corsa \{8,9,10,11,12\}Km/h\\
			\textbf{Soggetti}& 5\\
			\hline
			\textbf{Durata}& 2 minuti per attività\\
			\textbf{Strumenti 1} & IMU, Vicon, Treadmill\\
			\textbf{Luogo}& Laboratorio\\
			\hline
		\end{tabular}
	\caption{Tabella riassuntiva della raccolti dati}
	\label{tab:TabellaRiassuntivaRaccoltaDati}
\end{table}

Le sessioni sono state tutte eseguite posizionando una IMU \ref{sec:sensori} sul collo del piede dei soggetti. Il tipo di sensore usato è un giroscopio monoassiale con asse di sensibilità orientato sul piano mediale-laterale (vedi figura \ref{fig:HumanBodySPL}).\\
I segnali sono stati raccolti dal sensore ad una frequenza di 100 Hz e filtrati passa-basso\footnote{Un filtro passa-banda, è uno strumento elettronico che lascia passare frequenze in un intervallo e blocca il passaggio o di frequenze (o le attenua) fuori dall'intervallo. Un passa-basso lascia passare le frequenze basse, e smorza quelle a frequenze alte.} a 15Hz mediante un filtro forward-backward\footnote{Il filtro viene passato in entrambe le direzioni per avere un segnale simmetrico} di Butterworth\footnote{Detto anche filtro a magnitudine massimamente piatta nella banda che passa, in modo da avere meno disturbo possibile.}. Dai dati raccolti, quelli considerati per lo studio sono quelli compresi nell'intervallo dai 50 ai 110 secondi. \\
I dati acquisiti con la IMU sono stati sincronizzati con i dati acquisiti mediante stereofotogrammetria. A tale scopo è stato impiegato un sistema ottico di analisi del moto commerciale, Vicon \cite{vicon.com}, composto di 4 telecamere posizionate intorno al treadmill, in modo da poter tracciare il movimento di 5 marker retroriflettenti\footnote{Dispositivo o superficie che riflette la luce alla sua sorgente minimizzando la dispersione di luce}. I marker sono dei bulbi sferici in plastica di circa 14mm di diametro, attaccati ad una superficie quadrata della stessa dimensione, alle quali viene applicato del nastro biadesivo, mediante il quale vengono incollate sulla parte del corpo che vuole studiare. I marker sono stati posizionati sull'arto inferiore sinistro: sul tallone, sulla lato esterno della caviglia, sulla giuntura metatarso-falange dell'alluce, sulla coscia e sulla schiena, tra la zona lombare e sacrale. Il sistema Vicon, con il software \TODO{Vicon Tracker 1.2} ha tracciato la traiettoria in 3D, con un campionamento a 50Hz ed un accuratezza di $\pm$10 mm. e ricostruito tutta la sequenza di movimenti in 3D degli esperimenti, visualizzandoli a video. Dai dati ottenuti con il sistema Vicon sono stati generati dei segnali di riferimento per le fasi del cammino mediante la procedura descritta in \cite{reliable_gait_phase_anslysis}.\\

\begin{figure}
	\centering
		\includegraphics[width=1\textwidth]{imgs/patternGyro.jpg}
	\caption{Grafico del segnale di un giroscopio posizionato sul piede}
	\label{fig:gyroPattern}
\end{figure}

Il grafico del segnale del giroscopio posizionato sul piede ha una struttura abbastanza definita e ripetitiva (vedi grafico \ref{fig:gyroPattern}). Assumendo di cominciare dal piede in aria, qualche istante prima che stia per atterrare con il tallone, si ha il grafico nel punto di coordinata $(0,0)$. Da qui questo in circa 30 secondi raggiunge un picco negativo di circa -200°/secondi($min_1$). Da questo vertice risale a "V" (con la stessa pendenza ma di segno positivo) a 0°/sec. Successivamente per circa 50 secondi il piede rimane a velocità angolare 0°/secondi, dopo di che la curva precipita verso il suo minimo, tracciando una curva concava. Dopo 50 secondi circa di precipizio questa giunge a -450°/sec ($min$). Appena raggiunto il minimo, risale quasi verticalmente (in meno di 50 secondi) al valore massimo, circa 450 ($max$). Dal massimo riscende allo 0°/sec in due tratti, di cui il secondo è più lungo e di pendenza maggiore, simile a quello con cui la curva è risalita al picco massimo, ma decrescente. Da questo punto lo stesso scenario si ripete ad ogni passo, se non si modificano le condizioni di esecuzione del movimento.\\
In un ciclo di cammino possono essere identificate fino a 8 fasi (vedi capitolo \ref{cap:chinesiologia}). Per tenere basso il numero di parametri è stato deciso di accorpare le fasi riducendole a 4 (vedi tabella \ref{tab:4_fasi_deambulazione}). La prima fase $S_1$ è quella nell'intervallo fra gli eventi $t_{HS}$ a $T_{FF}$, la seconda $S_2$ è quella compresa fra gli eventi $t_{FF}$ a $t_{HO}$, la terza $S_3$ fra $t_{HO}$ a $t_{FO}$ e l'ultima $S_1$ è quella che chiude il ciclo $t_{FO}$ a $t_{HS}$.

\begin{table}%
\centering
\begin{tabular}{|c|cc|}
\hline
\textbf{Stato} & \textbf{inizio} & \textbf{fine} \\
%\hline
\hline
$S_1$ & $t_{HS}$ & $t_{FF}$\\
%\hline
$S_2$ & $t_{FF}$ & $t_{HO}$\\
%\hline
$S_3$ & $t_{HO}$ & $t_{FO}$\\
%\hline
$S_4$ & $t_{FO}$ & $t_{HS}$\\
\hline	 
\end{tabular}
\caption{Le quattro fasi della deambulazione e gli eventi (tempo iniziale e finale) che li definiscono.}
\label{tab:4_fasi_deambulazione}
\end{table}
Per semplicità si può indicare uno stato $S_i$ con l'evento da cui ha inizio, ad esempio con lo stato $HS$ indico lo stato $S_1$.

Gli eventi ($t_{HS}$, $t_{FF}$, $t_{HO}$, $t_{FO}$ ) sono determinati mediante soglie, sulla velocità angolare $\omega_k$, ricavate da studi pregressi \cite{walking_features_from_inertials} come mostra la Tabella \ref{tab:regole_threshold_eventi}, dove $\widetilde{\omega_k}$ è il valore non filtrato del giroscopio.

\begin{table}%
\centering
\begin{tabular}{|c|l p{5cm}|}
\hline
\textbf{Evento} & \multicolumn{2}{c|} {\textbf{regola}}\\
%\hline
\hline
$t_{HS}$ & $ \omega_k \leq 0 $ e $ min_1 \leq  \omega_k$ & $\displaystyle\max_{\forall k}|\widetilde{\omega_k} - \omega_k|$\\
%\hline
$t_{FF}$ & $|\omega_k|\geq  ??$°/sec&\\
%\hline
$t_{HO}$ & $|\omega_k|\geq  50$°/sec &\\
%\hline
$t_{FO}$ & $\omega_k = 0$ & se $\omega$ da negativo è diventato positivo e cresce fino al suo massimo.\\
\hline	 
\end{tabular}
\caption{Regole mediante le quali vengono ricavati gli eventi che delimitano le 4 fasi del cammino.}
\label{tab:regole_threshold_eventi}
\end{table}

Si assume che i segnali del giroscopio siano modellati mediante una HMM:
 \begin{equation}
	Deamb\_HMM = <N, M, \mathbf{A}, \mathbf{B}, \pi>
\label{eq:deamb_hmm}
\end{equation}
dove:
 \begin{enumerate}
	\item $N = 4$ è la cardinalità dell'insieme degli stati $S = \{HS, FF, HO, FO\}$,
	\item $M = |V|$ è la cardinalità dell'insieme finito dei valori di osservazione $\omega$ (°/sec) del giroscopio,
	\item $\mathbf{A}$ è la matrice di transizione (vedi appendice \ref{cap:hmm}),
	\item $\mathbf{B}$ è la matrice di probabilità di emissione delle osservazioni $\omega$ per ciascuno stato. Ad ogni stato è stata associata una funzione di densità di probabilità gaussiana univariata.
	\item $\pi$ è il vettore di probabilità a priori.
\end{enumerate}

A questo punto sono state addestrate le HMM. 
Come prima operazione, è stato etichettato un sottoinsieme dei dati: ad una sequenza $\Omega$ di dati è stato  associato un vettore $Y$ di etichette. Questo è stato fatto con l'uso di un sistema stereofotogrammetrico (sistema di telecamere Vicon).

%Grazie a un analisi di tipo stereofotogrammetrico (sistema di telecamere Vicon (vedi \TODO{Pappas}) sono stati etichettati i dati acquisiti. 

% addestramento HMM 

Dato che nella deambulazione normale le uniche transizioni tra stati sono quelle tra stati contigui o quelle che riportano nello stesso stato, il modello migliore il tipo di HMM scelto è il modello left-right (vedi appendice \ref{sec:tipi_hmm}). Ciò significa che la matrice di transizione gode della proprietà di avere transizioni solo verso stati successivi (da qui il nome "da sinistra - a destra"):
\begin{equation}
	a_{ij} > 0 \quad \text{sse} \quad j=i \quad \text{oppure}\quad j=i+1 \quad \text{oppure} \quad(i = N \quad\text{e}\quad j = 1)
\label{eq:}
\end{equation}
Una volta deciso il tipo di HMM da adottare, si devono stimare i parametri del modello.
La stima (dei parametri del modello) della massima verosimiglianza (Maximum Likelihood Estimation - MLE) $\ell(\Omega, Deamb\_HMM )$ non è un problema convesso dato. Il problema dei massimi locali viene aggirato con un'attenta inizializzazione dei parametri. 

Assumendo che possa avvenire solo una transizione tra stati contigui, in ciascun ciclo di deambulazione possono essere fatte delle stime approssimative dei paramtri della HMM:
\begin{equation}
\begin{split}
\pi_i & = N_i/N_{tot} \\
a_{ij}& = C/N_i \quad \text{dove}\quad j = (i+1)\%Q \\
\mu_i &= \dfrac{1}{N_i} \displaystyle \sum_{t=1}^T{\Omega(t)}\\
\sigma_i &= \sqrt{\dfrac{1}{N_i -1}\displaystyle \sum_{t=1}^T({\Omega(t)-\mu_i})^2}
\end{split}	 
\label{eq:emissionMtx}
\end{equation}
dove $N_i$ è il numero di valori etichettati con l'etichetta $i$-esima nel vettore di etichette $Y$ e $C$ è il numero di cicli di deambulazione nel training set.\\ 
\ERR{VERRI: POCJO CHIARO - 
I parametri di emissione ( $\mu$ e $\sigma$) per ciascuno stato $i$ sono stimati calcolando delle medie e deviazioni standard empiriche dagli output osservabili dei quali si conosce lo stato che li ha emessi.\\
}
La validazione è stata fatta con l'approccio leave-one-subject-out cross-validation (LOOCV). 
Il metodo consiste nell'addestrare un modello su P-1 ($P=6$) soggetti e testarne la validità su 1 soggetto. Ripetendo P volte la procedura per ciascuno dei soggetti alla fine i risultati vengono combinati.\TODO{spiegare come più in dettaglio}


Tutta la prima fase della creazione addestramento e validation incrociata del modello è stata fatta off-line, mediante un Mathworks MATLAB (R2008a) ed l'HMM toolbox \cite{HMM_toolbox}. 
Nella fase di test, viene usato l'algoritmo di decodifica di Viterbi \ref{alg:viterbi} sui dati del giroscopio, per trovare la sequenza di stati che con maggior verosimiglianza ha prodotto le osservazioni (sequenze di valori del giroscopio).
Il modello left-right può portare a considerare cicli di deambulazione aggiuntivi (insertions), o meno di quelli effettivi (deletions). Il problema delle inserzioni viene risolto mediante l'applicazione di un'euristica: per i presupposti del tipo di deambulazione considerata (velocità e pendenza del terreno).\\

I parametri del modello stimati da una delle esecuzioni della validazione incrociata è il seguente:
Dati:  HMM



\begin{table}%
\centering
\begin{tabular}{|c|c c c c|}
\hline
\textbf{A} &\textsc{HS} & \textsc{FF} & \textsc{HO} & \textsc{TO}\\
%\hline
\hline
\textsc{HS} & $0.985$ & $0.015$ & $0.0$ & $0.0$\\
%\hline
\textsc{FF} & $0.0$ & $0.998$ & $0.002$ & $0.0$\\
%\hline
\textsc{HO} & $0.0$ & $0.0$ & $0.991$ & $0.009$\\
%\hline
\textsc{FO} & $0.007$ & $0.0$ & $0.0$ & $0.993$\\
\hline	 
\end{tabular}
\caption{Matrice di Transizione}
\label{tab:matrice_transizione}
\end{table}


\begin{table}%
\centering
\begin{tabular}{|c|c c|}
\hline
\textbf{B} &\textsc{$\mu$[°/sec]} & \textsc{$\sigma ^2$[°/sec]}\\
%\hline
\hline
\textsc{HS} & $-52.2$ & $12711.8$\\
%\hline
\textsc{FF} & $-11.8$ & $898.7$\\
%\hline
\textsc{HO} & $-180.1$ & $35806.8$\\
%\hline
\textsc{FO} & $233$ & $14980.3$\\
\hline	 
\end{tabular}
\caption{Matrice di Emissione}
\label{tab:matrice_emissione}
\end{table}


\begin{table}%
\centering
\begin{tabular}{|p{.7cm}|p{2.8cm}|}
\hline
 &\textsc{$\pi$} \\
%\hline
\hline
\textsc{HS} & $0.180$ \\  
%\hline
\textsc{FF} & $0.278$ \\
%\hline
\textsc{HO} & $0.279$ \\
%\hline
\textsc{FO} & $0.264$\\
\hline	 
\end{tabular}
\caption{Distribuzione di probabilità iniziale}
\label{tab:prior}
\end{table}
Le seguenti sono un esempio di osservazioni: 12400 dati Giroscopio
\begin{table}%
\centering
\begin{tabular}{|c|c|}
\hline
 time&\textsc{$O$} \\
%\hline
\hline
\textsc{1} & $0.37694$\\  
\textsc{2} & $0.37694$\\
\textsc{3} & $0.37694$\\
\textsc{4} & $0.37694$\\
\textsc{5} & $-1.9058$\\
\vdots & \vdots\\
\textsc{24800} & $-16.831$\\
\hline	 
\end{tabular}
\caption{Osservazioni Giroscopio: velocità angolari}
\label{tab:osservazioni}
\end{table}

%I risultati ottenuti hanno un errore che va dal 3.5\% al 4.7\% che sono errori trascurabili se si considera il numero di fattori in gioco.

%\section[Direzione scelta]{Strategia scelta per la risoluzione del problema dell'analisi del cammino}
%\begin{figure}
%	\centering
%		\includegraphics[width=1\textwidth]{imgs/SchemaClassificazioneGenerica.jpg}
%	\caption{Schema concettuale di un sistema di classificazione generico}
%	\label{fig:SchemaClassificazioneGenerica}
%\end{figure}
%\subsection{Selezione dei Sensori}
%\subsection{Acquisizione dei dati}
%\subsection{Specifica delle Feature: valutazione, selezione, estrazione}
%I dati acquisiti devono essere elaborati prima di essere classificati. La classificazione viene fatta su delle rappresentazioni dei dati come variabili di feature (attributi). La scelta dei feature viene fatta caso per caso. 
%La valutazione di feature, avviene spesso in finestre di dimensione fissa che vengono chiamate dataframe. \\
%
%Le feature devono essere selezionate per un triplice motivo: migliorare la performance della classificazione, in modo più rapido (perché diminuisce il numero di variabili della computazione)e fornire una comprensione migliore del processo sottostante alla generazione dei dati in considerazione. 
%Guyon et al.\cite{intro_variable_feature_selection} nel loro articolo danno un algoritmo euristico per una buona selezione di feature:
%
%\begin{enumerate}
%	\item \textbf{Conosci il dominio del problema?} Se si, costruisci un insieme migliore di feature ad-hoc.
%	\item \textbf{Le tue feature sono proporzionate?} Se no normalizzale.
%	\item \textbf{Sospetti un'interdipendenza di feature?} Se si, espandi il tuo insieme di feature, costruende feature congiuntive o prodotti di feature, al massimo delle potenzialità del tuo computer.
%	\item \textbf{Devi potare le variabili di input (per motivi di velocità, o migliore comprensione dei dati)?} Se no, costruisci delle feature disgiuntive o somme pesate di feature (ad esempio per raggruppamenti (clustering) o fattorizzazioni di matrici)
%\item \textbf{Devi valutare delle feature individualmente (ad esempio per capire il loro impatto sul sistema o perché sono così tanti che devi prima fare un filtraggio?)} Se si, usa un metodo di ranking di variabili, altrimenti fallo lo stesso per avere dei risultai di partenza. 
%\item \textbf{Sospetti che i tuoi dati siano spuri? (Hanno alcuni input senza senso o output con del rumore o con etichette di classi errate)}.Se si, individua gli esempi sbagliati con il ranking del passo precedente come gli esempi con il punteggio più alto ed esaminali o eliminali. 
%\item \textbf{Sai cosa provare prima?} Se no, usa un predittore lineare. Usa un metodo di selezione forward, con un un criterio di arresto a sonda (probe). Per confrontare i risultati, in base al ranking, costruisci una sequenza di predictor, che si differenzino solo per la grandezza del sottoinsieme di feature che usano.
%Puoi ridurre le dimensioni dei sottoinsiemi ed avere una performance pari o addirittura migliore? Se si, prova un predictor non-lineare con quel particolare sottoinsieme. 
%\end{enumerate}
%
%\subsection{Valutazione}
%\subsection{Selezione}
%\subsection{Estrazione}
%\subsection{Fase di addestramento}
%\subsection{Selezione ed Estrazione delle Feature}
%\subsection{Classificazione}
%
%\subsection{Fase di valutazione}
%\subsection{Selezione ed Estrazione delle Feature}
%\subsection{Classificazione}
%\subsection{Valutazione di performance}
%
%
%\section{Hardware}
%IMU \footnote{Inertial Measurement Unit}
%\begin{itemize}
%	\item Scheda -- dimensioni--processore, RAM, memoria FLASH
%	\item Bluetooth
%	\item Gyroscope
%\end{itemize}
%\section{software}
%\begin{itemize}
%	\item sistema operativo IMU
%	\item protocollo di comunicazione Mailbox
%	\item Ambiente Android 
%	\item Algoritmi di Machine Learning 
%\end{itemize}


